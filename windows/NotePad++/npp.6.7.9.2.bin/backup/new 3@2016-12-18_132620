define("history/main",["require","jquery","hogan","./tpl/history.tpl","./tpl/hot.tpl","./tpl/nav.tpl","./tpl/hotTop.tpl","./tpl/item.tpl","./tpl/list.tpl","./tpl/pager.tpl","./tpl/noToday.tpl","common/confirmTpl.tpl","common/Remoter","common/dateFormat","common/config","./historyPop","./setting","common/confirm","common/tips","./his-charts-line"],function(require){function init(){view.container=$("#history"),initEvents(),initRequest(),historyStatus.remote(),$("body").on("listUpdate",function(e,t){model.status=t.open,historyList.remote({channel:model.channel.join(",")})})}function initEvents(){initSelectItem(),initSelectAll(),initListItemSwitch(),initListSwitch(),initCollect(),initDel(),initPager(),initHotSwitch()}function initRequest(){initDelRequest(),initDelAllRequest(),initHistoryListRequest(),initCheckStatusRequest(),initCollectRequset(),initChartsRequest(),initHotListRequest()}function initData(e){if(model.queryList=$.extend(!0,[],e),model.queryLength=model.queryList.length,!model.isprev)combineList({datetime:"今天"});for(var t=0;t<model.queryLength;t++){var i=dateFormat.format(new Date(1e3*+model.queryList[t].ts)),n=dateFormat.format(new Date);i===n&&(i="今天"),model.queryList[t].datetime=i,model.queryList[t].bz=config.URL.BAOZHANG_CLICKLIST;for(var r in model.queryList[t].clicks)model.queryList[t].clicks[r].zIndex=model.zIndex--;model.queryList[t].isopen=model.isopen,combineList(model.queryList[t])}$(".history-list-contentbox:eq(0)").append(view.pager);var a=$(".ht-day-item:eq(0)");!a.find(".ht-day-item-search").length&&a.append(hogan.compile(NO_TODAY).render())}function combineList(e){var t=$(".ht-day-item"),i=0;if(t.each(function(){var t=$(this).attr("data-date");if(t===e.datetime)return i=1,$(this).find(".ht-day-item-lists:eq(0)").append(hogan.compile(HISTORY_ITEM).render(e)),$(".ht-day-item-search-keyword ,.ht-day-item-sl-keyword").attr("data-click",LOG_TARGET_STR),!1;else return void 0}),!i){if(0===t.length)$(".history-list-contentbox:eq(0)").append(hogan.compile(HISTORY_LIST).render({first:!0,time:e.datetime}));else $(".history-list-contentbox:eq(0)").append(hogan.compile(HISTORY_LIST).render({time:e.datetime}));if(e.ts)combineList(e)}}function initSelectItem(){$("body").delegate(".history-list-checkbox","click",function(e){e.stopImmediatePropagation();var t=$(this).closest(".ht-day-item-list"),i=$(this).closest(".ht-day-item").find(".ht-day-item-list");if(t.hasClass("checked"))t.removeClass("checked"),view.checkAll.removeClass("current"),$(this).closest(".ht-day-item").removeClass("current");else{t.addClass("checked");var n=0;i.each(function(){if(!$(this).hasClass("checked"))return n=1,!1;else return void 0}),!n&&$(this).closest(".ht-day-item").addClass("current")}var r=0;$(".ht-day-item-list").each(function(){if($(this).hasClass("checked"))return r=1,!1;else return void 0}),r?view.delBtn.removeClass("disabled"):view.delBtn.addClass("disabled")})}function initSelectAll(){$("body").delegate(".history-list-op-check","click",function(){var e=hogan.compile(confirmTpl).render({title:"确定清空所有记录吗？"});confirm.show({options:{content:e},callback:{sure:function(){historyDelAll.remote({clear:!0})},cancel:function(){}}})})}function initListItemSwitch(){$("body").delegate(".ht-day-item-search-keyword","click",function(e){e.stopImmediatePropagation()}),$("body").on("click",".ht-day-item-search",function(){var e=$(this).closest(".ht-day-item-list");if(!e.hasClass("hide-open-icon"))e.hasClass("current")?e.removeClass("current"):e.addClass("current")})}function initListSwitch(){$("body").on("click",".history-list-op-status",function(){var e=$(this);if(e.hasClass("current"))model.isopen=0,e.removeClass("current"),$(".ht-day-item-list").removeClass("current");else model.isopen=1,e.addClass("current"),$(".ht-day-item-list").addClass("current")})}function initCollect(){$("body").delegate(".ht-day-item-sl-op-col","click",debounce(function(){view.collectBtn=$(this);var e=$(this).closest(".ht-day-item-searchlist-item").find(".ht-day-item-sl-keyword:eq(0)");if(!$(this).hasClass("current"))collectAdd.remote({t:e.attr("title"),url:e.attr("href"),ucid:$(this).attr("data-ucid"),src:6});else collectDel.remote({url:e.attr("href")})},1e3,!0))}function initDel(){$("body").delegate(".history-list-op-del","click",debounce(function(){if(!$(this).hasClass("disabled")){var e=$(".ht-day-item-list"),t=[];if(e.each(function(){var e=$(this),i=e.attr("data-query");if(e.hasClass("checked")){var n={};n.sid=e.attr("data-id"),n.ts=e.attr("data-ts"),n.query=e.attr("data-query"),t.push(n),delQueryList[i]=1}}),!t.length)return alert("请选择要删除的搜索记录！"),!1;else return void historyDel.remote({sids:JSON.stringify(t)})}},1e3,!0))}function initPager(){$("body").delegate(".prev-pager","click",function(){if(!$(this).hasClass("disabled"))historyList.remote({channel:model.channel.join(","),ts:$(this).attr("data-ts"),after:1,page:model.currentPage-1,query:$(".history-search-input").val()})}),$("body").delegate(".next-pager","click",function(){if(!$(this).hasClass("disabled"))historyList.remote({channel:model.channel.join(","),ts:$(this).attr("data-ts"),after:0,page:model.currentPage+1,query:$(".history-search-input").val()})})}function initSearchHistory(){function e(){var e=t.val();pop.close(),historyList.remote({channel:model.channel.join(","),query:e}),t.blur(),setTimeout(function(){$(window).scrollTop(430)},300)}var t=$(".history-search-input");$("body").on("click",".history-search-btn",function(){e()}),t.on("keydown",function(t){if(13===t.keyCode)e()})}function initHotSwitch(){$("body").on("click",".history-hot-title-link",function(){var e=$(".ibx-history-hotTop");if(e.hasClass("hotTop-close"))e.removeClass("hotTop-close").addClass("hotTop-open");else e.removeClass("hotTop-open").addClass("hotTop-close")})}function initDelRequest(){historyDel.on("success",function(e){redirect(e),pop.close(),historyList.remote({channel:model.channel.join(","),ts:$(".prev-pager:eq(0)").attr("data-ts"),after:0,page:model.currentPage,query:$(".history-search-input").val()}),tips.show()})}function initDelAllRequest(){historyDelAll.on("success",function(e){historyList.remote({channel:model.channel.join(","),ts:$(".prev-pager:eq(0)").attr("data-ts"),after:0,page:model.currentPage,query:$(".history-search-input").val()}),tips.show()})}function initHistoryListRequest(){historyList.on("success",function(e){if(e.list&&e.list.length)redirect(e),model.currentPage=+e.current,model.isprev=e.current,model.zIndex=50,view.container.html(hogan.compile(tpl).render({islist:1,status:model.status,statusTm:model.statusTm,isopen:model.isopen})),view.pager=hogan.compile(HISTORY_PAGER).render({next:e.ts_start,prev:e.ts_end,isprev:!e.current,isnext:!e.next}),view.checkAll=$(".history-list-op-check:eq(0)"),view.delBtn=$(".history-list-op-del:eq(0)"),view.selectBtn=$("#history-list-op-selected"),$.each(e.list,function(){if(500===this.channel||501===this.channel)this.isPhone=!0;if(!this.clicks||!this.clicks.length)this.isNoClick=!0;if(505===this.channel)this.isImage=!0;this.typeText=HIS_TPYE_MAP[this.query_style]||"搜索"}),initData(e.list);else view.container.html(hogan.compile(tpl).render({islist:0,status:model.status,statusTm:model.statusTm}))})}function initCheckStatusRequest(){historyStatus.on("success",function(e){redirect(e),model.status=+e.open,model.statusTm=dateFormat.format(new Date(1e3*+e.time)),$(hogan.compile(historyNav).render({status:model.status,statusTm:model.statusTm})).insertBefore("#history"),initSearchHistory(),chartsDataMonth.remote().error(function(){$(".hot-history-wrap").html("")}),historyList.remote({channel:model.channel.join(",")}),setting.init(e)})}function initCollectRequset(){collectAdd.on("success",function(){view.collectBtn.addClass("current"),view.collectBtn.find(".ht-day-item-sl-op-col-ctx:eq(0)").html("已收藏")}),collectDel.on("success",function(){view.collectBtn.removeClass("current"),view.collectBtn.find(".ht-day-item-sl-op-col-ctx:eq(0)").html("收藏")})}function initChartsRequest(){chartsDataMonth.on("success",function(data){if($(hogan.compile(hotHistory).render({time:"近30天",scount:data.scount||0,rank:data.average_rank||0,average:Math.round(eval(data.average.y.join("+"))/30)})).insertAfter(".history-tipbar"),increaseByDegrees(),data)chartsLine.render("ibx-charts-line",data);else $("#ibx-charts-line").html(etpl.render("history-empty",{tip:"貌似出了点小问题，程序员gg正在努力修复中",top:30}));getHot.remote()})}function increaseByDegrees(){var e=$(".history-title-rank-item-data span");$.each(e,function(){var e=$(this),t=e.attr("data-count"),i=e.attr("data-rank");if(+t||+i)if(t)e.animate({innerHTML:t},{step:function(e,t){t.now=parseInt(e)},duration:900});else if(i)e.animate({innerHTML:i},{step:function(e,t){t.now=parseInt(10*e)/10},duration:900})})}function initHotListRequest(){getHot.on("success",function(e){var t=$(".hot-history-top");if(t){for(var i=[],n=[],r=null,a=1;11>a;a++)if(r=e.data[a],r.rank=a,6>a){if(4>a)r.cname="current";i.push(r)}else n.push(r);t.html(hogan.compile(hotTop).render({resultLeft:i,resultRight:n}))}else return!1})}function redirect(e){if(302===e.status&&e.statusInfo)return void(window.location.href=e.statusInfo);else return void 0}function debounce(e,t,i){var n;return function(){var r=this,a=arguments,o=function(){if(n=null,!i)e.apply(r,a)},s=i&&!n;if(clearTimeout(n),n=setTimeout(o,t),s)e.apply(r,a)}}function initSyncDelRequest(e,t){var i=e||"",n=new Image;n.src=t+i}function sendSyncDelRequest(){$.each(delQueryList,function(e,t){if(t)initSyncDelRequest("?query="+e,SYNC_DEL_URL),delQueryList[e]=0})}function sendSyncDelAllRequest(){if(!delQueryList.length)initSyncDelRequest("",SYNC_DEL_ALL_URL)}var $=require("jquery"),hogan=require("hogan"),tpl=require("./tpl/history.tpl"),hotHistory=require("./tpl/hot.tpl"),historyNav=require("./tpl/nav.tpl"),hotTop=require("./tpl/hotTop.tpl"),HISTORY_ITEM=require("./tpl/item.tpl"),HISTORY_LIST=require("./tpl/list.tpl"),HISTORY_PAGER=require("./tpl/pager.tpl"),NO_TODAY=require("./tpl/noToday.tpl"),confirmTpl=require("common/confirmTpl.tpl"),Remoter=require("common/Remoter"),dateFormat=require("common/dateFormat"),config=require("common/config"),pop=require("./historyPop"),setting=require("./setting"),confirm=require("common/confirm"),tips=require("common/tips"),chartsLine=require("./his-charts-line"),historyList=new Remoter("HISTORY_LIST"),historyDelAll=new Remoter("HISTORY_DEL"),historyDel=new Remoter("HISTORY_DEL"),historyStatus=new Remoter("HISTORY_STATUS"),collectAdd=new Remoter("COLLECT_ADD"),collectDel=new Remoter("COLLECT_CANCEL_DEL"),chartsDataMonth=new Remoter("HOME_ECHARTS_MONTH"),getHot=new Remoter("HOME_TOP"),SYNC_DEL_URL="http://api.open.baidu.com/pae/hsug/data/Delete/",SYNC_DEL_ALL_URL="http://api.open.baidu.com/pae/hsug/data/Deleteall/",LOG_TARGET_STR='{"act": "card_history_detail_link"}',HIS_TPYE_MAP={text:"搜索",audio:"语音搜索",image:"图片搜索"},view={},model={queryList:[],queryLength:0,channel:[201,202,300,301,302,303,400,100,500,501,505],currentPage:0,status:0,statusTm:"",isopen:1,zIndex:50,channelStatus:0},delQueryList={};init()});